rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Roles: 'authority', 'ngo', 'responder', 'citizen'
    function isAuthority() {
      return isAuthenticated() && getUserData().role == 'authority';
    }
    
    function isNGO() {
      return isAuthenticated() && (getUserData().role == 'ngo' || isAuthority());
    }

    function isResponder() {
      return isAuthenticated() && (getUserData().role == 'responder' || isAuthority());
    }

    // --- Collections ---

    // 1. Users
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow users to create their own doc during signup
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to update their own non-role fields
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Admin/Authority can update roles/data
      allow update: if isAuthority();
      allow delete: if isAuthority();
    }

    // 2. Hazard Reports
    match /reports/{reportId} {
      // Citizens can only read their own reports; authorities/responders can read all
      // Relaxed for debugging map issues
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Only Authorities/Responders can verify/update status
      allow update: if isResponder();
      // Only Admin can delete
      allow delete: if isAuthority();
    }

    // 3. Volunteers
    match /volunteers/{volunteerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthority();
      allow delete: if isAuthority();
    }

    // 4. Drills
    match /drills/{drillId} {
      allow read: if isAuthenticated();
      allow write: if isAuthority();
    }

    // 5. Circulars / Alerts
    match /circulars/{circularId} {
      allow read: if isAuthenticated();
      allow write: if isAuthority();
    }

    // 6. Alerts (System Alerts)
    match /alerts/{alertId} {
      allow read: if isAuthenticated();
      allow write: if isAuthority();
    }

    // 7. Notification Settings
    match /notificationSettings/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 8. Donations
    match /donations/{donationId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAuthority());
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAuthority(); // Only authority can update status
      allow delete: if isAuthority();
    }

    // 9. Campaigns
    match /campaigns/{campaignId} {
      allow read: if true; // Public
      allow create, update: if isAuthority();
      allow delete: if false; // Never delete campaigns
    }

    // 10. System Core Settings
    match /systemSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthority();
    }

    // 11. NGO Resources
    match /ngoResources/{resourceId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isNGO();
    }

    // 12. Field Teams
    match /fieldTeams/{teamId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isNGO();
    }

    // 13. Deployments
    match /deployments/{deploymentId} {
      allow read: if isAuthenticated();
      allow create, update: if isNGO();
      allow delete: if isNGO();
    }

    // 14. Notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow users to mark as read
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Backend creates notifications usually, but allowing create for flexibility if needed
      allow create: if isAuthority(); 
    }
  }
}

